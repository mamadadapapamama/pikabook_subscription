// ğŸ“ functions/subscription/checkSubscriptionStatus.js
// ë©”ì¸ êµ¬ë… ìƒíƒœ í™•ì¸ í•¨ìˆ˜ (Apple ê³µì‹ ë¼ì´ë¸ŒëŸ¬ë¦¬)
const {onCall, HttpsError} = require("firebase-functions/v2/https");
const admin = require("firebase-admin");
const {PlanStatus} = require("../shared/constant");
const {checkInternalTestAccount} = require("../utils/testAccounts");
const {checkAppStoreConnect} = require("./appStoreConnectService");
const {
  appstoreKeyId,
  appstoreIssuerId,
  appstorePrivateKey,
  appstoreBundleId,
} = require("../utils/appStoreServerClient");

/**
 * ğŸš€ í†µí•© êµ¬ë… ìƒíƒœ í™•ì¸ í•¨ìˆ˜ (Apple ê³µì‹ ë¼ì´ë¸ŒëŸ¬ë¦¬ ê¸°ë°˜)
 *
 * âœ… ì£¼ìš” ê°œì„ ì‚¬í•­:
 * - Apple ê³µì‹ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©ìœ¼ë¡œ ì•ˆì •ì„± ëŒ€í­ í–¥ìƒ
 * - ìë™ JWT í† í° ê´€ë¦¬ ë° ì—ëŸ¬ ì²˜ë¦¬
 * - íƒ€ì… ì•ˆì „ì„± ë° API í˜¸í™˜ì„± ë³´ì¥
 * - ì¬ì‹œë„ ë¡œì§ ë° graceful fallback
 * @param {object} request - Firebase Functions ìš”ì²­
 * @return {Promise<object>} êµ¬ë… ìƒíƒœ ì •ë³´
 */
const subCheckSubscriptionStatus = onCall({
  region: "asia-southeast1",
  secrets: [
    appstoreKeyId,
    appstoreIssuerId,
    appstorePrivateKey,
    appstoreBundleId,
  ],
}, async (request) => {
  try {
    console.log("ğŸš€ [Apple Official Library] í†µí•© êµ¬ë… ìƒíƒœ í™•ì¸ ì‹œì‘");

    if (!request.auth) {
      throw new HttpsError(
        "unauthenticated",
        "User must be authenticated",
      );
    }

    const userId = request.auth.uid;
    const email = request.auth.token?.email;

    console.log("ğŸ” êµ¬ë… ìƒíƒœ í™•ì¸ ì‹œì‘ (userId: " + userId +
      ", email: " + email + ")");

    // ğŸ¯ Step 1: ë‚´ë¶€ í…ŒìŠ¤íŠ¸ ê³„ì • í™•ì¸ (ìµœìš°ì„ )
    const testAccountResult = checkInternalTestAccount(email);
    if (testAccountResult) {
      console.log(
        "ğŸ§ª ë‚´ë¶€ í…ŒìŠ¤íŠ¸ ê³„ì •ìœ¼ë¡œ êµ¬ë… ìƒíƒœ ë°˜í™˜: " +
        testAccountResult.planStatus,
      );
      return {
        success: true,
        subscription: testAccountResult,
        dataSource: "test-account",
        version: "v3-official-library",
      };
    }

    // ë°ì´í„° ìˆ˜ì§‘ ë³€ìˆ˜
    let {originalTransactionId, appStoreFirst} = request.data;
    let subscriptionData = null;
    let dataSource = "unknown";

    // ğŸ¯ Step 2: App Store Connect ìš°ì„  í™•ì¸ (Apple ê³µì‹ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©)
    if (appStoreFirst) {
      try {
        console.log("ğŸš€ [Official Library] App Store Connect ìš°ì„  í™•ì¸ ì‹œì‘ " +
          "(userId: " + userId + ")");

        // originalTransactionIdê°€ ì—†ìœ¼ë©´ Firestoreì—ì„œ ì¡°íšŒ
        if (!originalTransactionId) {
          const db = admin.firestore();
          const userDoc = await db.collection("users").doc(userId).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            originalTransactionId =
              userData?.subscription?.originalTransactionId ||
              userData?.originalTransactionId;
          }
        }

        // ğŸš€ Apple ê³µì‹ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ App Store Connect API í˜¸ì¶œ
        if (originalTransactionId) {
          console.log("ğŸ“¡ [Official Library] App Store API í˜¸ì¶œ: " +
            originalTransactionId);

          const appStoreData = await checkAppStoreConnect(
            originalTransactionId,
          );

          if (appStoreData && appStoreData.planStatus !== PlanStatus.FREE) {
            subscriptionData = appStoreData;
            dataSource = "appstore-official-library";
            console.log(
              "âœ… [Official Library] App Store Connectì—ì„œ êµ¬ë… ì •ë³´ ë°œê²¬: " +
              subscriptionData.planStatus,
            );
          } else {
            console.log("âš ï¸ [Official Library] " +
              "App Store Connectì—ì„œ í™œì„± êµ¬ë… ì—†ìŒ");
          }
        } else {
          console.log("âš ï¸ [Official Library] originalTransactionId ì—†ìŒ");
        }
      } catch (error) {
        console.log("âŒ [Official Library] App Store Connect í™•ì¸ ì‹¤íŒ¨: " +
          error.message);
        // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ê³„ì† ì§„í–‰ (Firestore fallback)
      }
    }

    // ğŸ¯ Step 3: App Storeì— ë°ì´í„°ê°€ ì—†ìœ¼ë©´ Firebaseì—ì„œ í™•ì¸
    if (!subscriptionData) {
      try {
        console.log("ğŸ” [Firestore Fallback] Firebase ë°ì´í„° í™•ì¸ ì‹œì‘");

        const db = admin.firestore();
        const userDoc = await db.collection("users").doc(userId).get();
        if (userDoc.exists) {
          const userData = userDoc.data();

          // ğŸ”¥ ì›¹í›…ì´ ì €ì¥í•œ subscription í•„ë“œì—ì„œ ë°ì´í„° ì¡°íšŒ
          const subscription = userData.subscription;

          if (subscription && subscription.plan && subscription.status) {
            console.log("ğŸ“¦ [Firestore] ì›¹í›… êµ¬ë… ë°ì´í„° ë°œê²¬:", subscription);

            // ì›¹í›… ë°ì´í„°ë¥¼ EntitlementEngineì´ ê¸°ëŒ€í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const now = Date.now();
            const expiryDate = subscription.expiryDate?.toMillis() || 0;
            const isActive = subscription.status === "active" &&
              expiryDate > now;

            // planStatus ê³„ì‚°
            let planStatus = PlanStatus.FREE;
            let currentPlan = "free";

            if (isActive) {
              if (subscription.isFreeTrial) {
                planStatus = subscription.isCancelled ?
                  PlanStatus.TRIAL_CANCELLED : PlanStatus.TRIAL_ACTIVE;
                currentPlan = "trial";
              } else {
                if (subscription.isCancelled) {
                  planStatus = PlanStatus.PREMIUM_CANCELLED;
                } else {
                  planStatus = PlanStatus.PREMIUM_ACTIVE;
                }
                currentPlan = "premium";
              }
            } else if (subscription.status === "expired") {
              if (subscription.isFreeTrial) {
                planStatus = PlanStatus.TRIAL_COMPLETED;
                currentPlan = "premium"; // ì²´í—˜ ì™„ë£Œ í›„ëŠ” í”„ë¦¬ë¯¸ì—„ìœ¼ë¡œ ê°„ì£¼
              } else {
                planStatus = PlanStatus.PREMIUM_EXPIRED;
                currentPlan = "free";
              }
            } else if (subscription.status === "revoked") {
              planStatus = PlanStatus.REFUNDED;
              currentPlan = "free";
            }

            subscriptionData = {
              // EntitlementEngineì´ ê¸°ëŒ€í•˜ëŠ” í•„ë“œë“¤
              currentPlan: currentPlan,
              isActive: isActive,
              planStatus: planStatus,
              autoRenewStatus: subscription.autoRenewStatus || false,
              subscriptionType: subscription.plan === "premium" ?
                "monthly" : "monthly", // ê¸°ë³¸ê°’
              expirationDate: subscription.expiryDate?.toMillis()
                ?.toString() || null,

              // ì¶”ê°€ ì •ë³´
              hasEverUsedTrial: subscription.isFreeTrial || false,
              hasEverUsedPremium: subscription.plan === "premium" || false,
              originalTransactionId: subscription.originalTransactionId,
              lastNotificationType: subscription.lastNotificationType,
            };

            dataSource = "firestore-webhook";
            console.log("âœ… [Firestore] ì›¹í›… ë°ì´í„°ë¡œ êµ¬ë… ì •ë³´ ìƒì„±:", {
              currentPlan: subscriptionData.currentPlan,
              isActive: subscriptionData.isActive,
              planStatus: subscriptionData.planStatus,
              autoRenewStatus: subscriptionData.autoRenewStatus,
            });
          } else {
            // ê¸°ì¡´ ë ˆê±°ì‹œ í•„ë“œì—ì„œ ì¡°íšŒ (fallback)
            subscriptionData = {
              planStatus: userData.planStatus || PlanStatus.FREE,
              currentPlan: "free",
              isActive: false,
              expirationDate: userData.expirationDate,
              autoRenewStatus: userData.autoRenewStatus || false,
              hasEverUsedTrial: userData.hasEverUsedTrial || false,
              hasEverUsedPremium: userData.hasEverUsedPremium || false,
            };
            dataSource = "firestore-legacy";
            console.log("ğŸ“± [Firestore] ë ˆê±°ì‹œ Firebase ë°ì´í„° ì‚¬ìš©: " +
              subscriptionData.planStatus);
          }
        }
      } catch (error) {
        console.log("âŒ [Firestore] Firebase ë°ì´í„° í™•ì¸ ì‹¤íŒ¨: " +
          error.message);
      }
    }

    // ğŸ¯ Step 4: ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
    if (!subscriptionData) {
      subscriptionData = {
        planStatus: PlanStatus.FREE,
        currentPlan: "free",
        isActive: false,
        autoRenewStatus: false,
        hasEverUsedTrial: false,
        hasEverUsedPremium: false,
      };
      dataSource = "default";
      console.log(
        "ğŸ“ [Default] ê¸°ë³¸ê°’ìœ¼ë¡œ êµ¬ë… ì •ë³´ ì„¤ì •: " +
        subscriptionData.planStatus,
      );
    }

    console.log("âœ… [Final] êµ¬ë… ìƒíƒœ í™•ì¸ ì™„ë£Œ:", {
      planStatus: subscriptionData.planStatus,
      dataSource: dataSource,
      version: "v3-official-library",
    });

    return {
      success: true,
      subscription: subscriptionData,
      dataSource: dataSource,
      version: "v3-official-library",
      timestamp: new Date().toISOString(),
      libraryInfo: {
        isUsingOfficialLibrary: true,
        benefits: [
          "ìë™ JWT í† í° ê´€ë¦¬",
          "ì—ëŸ¬ ì²˜ë¦¬ ìë™í™”",
          "íƒ€ì… ì•ˆì „ì„± ë³´ì¥",
          "Apple ì—…ë°ì´íŠ¸ ìë™ í˜¸í™˜",
        ],
      },
    };
  } catch (error) {
    console.error("âŒ [Error] êµ¬ë… ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:", error);
    return {
      success: false,
      error: error.message,
      dataSource: "error",
      version: "v3-official-library",
      timestamp: new Date().toISOString(),
    };
  }
});

module.exports = {
  subCheckSubscriptionStatus,
};
