// ğŸ“ functions/src/subscription/extractOriginalTransactionId.js
const {onCall, HttpsError} = require("firebase-functions/v2/https");
const admin = require("firebase-admin");
const axios = require("axios");
const { APP_STORE_SERVER_API_URL } = require('../shared/constant');
const { generateServerJWT } = require('../utils/jwt');

/**
 * transactionIdë¡œ originalTransactionIdë¥¼ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜ (App Store Server API v2 ì‚¬ìš©)
 */
const extractOriginalTransactionId = onCall({
  region: "asia-southeast1",
}, async (request) => {
  try {
    console.log("ğŸ” extractOriginalTransactionId í˜¸ì¶œë¨");
    console.log("ğŸ“ ì…ë ¥ ë°ì´í„°:", request.data);
    
    // ì¸ì¦ í™•ì¸
    if (!request.auth) {
      console.error("âŒ ì¸ì¦ë˜ì§€ ì•Šì€ ìš”ì²­");
      throw new HttpsError('unauthenticated', 'Request must be authenticated');
    }

    const { transactionId, userId } = request.data;
    
    if (!transactionId || !userId) {
      console.error("âŒ í•„ìˆ˜ íŒŒë¼ë¯¸í„° ëˆ„ë½:", { transactionId: !!transactionId, userId: !!userId });
      throw new HttpsError('invalid-argument', 'transactionId and userId are required');
    }

    // App Store Server API v2ë¥¼ ì‚¬ìš©í•˜ì—¬ transaction ì •ë³´ ì¡°íšŒ
    const transactionInfo = await getTransactionInfo(transactionId);
    
    if (!transactionInfo.success) {
      console.error("âŒ Transaction ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:", transactionInfo.error);
      throw new HttpsError('internal', 'Failed to get transaction info from App Store');
    }

    const originalTransactionId = transactionInfo.originalTransactionId;
    
    if (!originalTransactionId) {
      console.error("âŒ originalTransactionIdë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ");
      throw new HttpsError('internal', 'originalTransactionId not found in transaction info');
    }

    // Firestoreì— originalTransactionId ì €ì¥
    const db = admin.firestore();
    await db.collection('users').doc(userId).set({
      originalTransactionId: originalTransactionId,
      lastTransactionId: transactionId,
      lastTransactionInfoUpdateAt: admin.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    console.log("âœ… originalTransactionId ì €ì¥ ì™„ë£Œ:", originalTransactionId);
    
    return {
      success: true,
      originalTransactionId: originalTransactionId
    };

  } catch (error) {
    console.error("âŒ extractOriginalTransactionId ì—ëŸ¬:", error);
    
    if (error instanceof HttpsError) {
      throw error;
    }
    
    throw new HttpsError('internal', 'Internal server error');
  }
});

/**
 * App Store Server API v2ë¥¼ ì‚¬ìš©í•˜ì—¬ transaction ì •ë³´ ì¡°íšŒ
 * @param {string} transactionId
 * @returns {Promise<{success: boolean, originalTransactionId?: string, error?: string}>}
 */
async function getTransactionInfo(transactionId) {
  try {
    console.log("ğŸ” App Store Server API v2ë¡œ transaction ì •ë³´ ì¡°íšŒ:", transactionId);
    
    const token = generateServerJWT();
    const apiUrl = `${APP_STORE_SERVER_API_URL}/inApps/v1/transactions/${transactionId}`;

    const response = await axios.get(apiUrl, {
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json",
      },
      timeout: 10000,
    });

    const transactionData = response.data;
    const signedTransactionInfo = transactionData.signedTransactionInfo;
    
    if (!signedTransactionInfo) {
      console.error("âŒ signedTransactionInfoê°€ ì—†ìŒ");
      return { success: false, error: 'No signedTransactionInfo in response' };
    }

    // JWT í† í° ë””ì½”ë”© (base64url decode)
    const payload = decodeJWT(signedTransactionInfo);
    
    if (!payload) {
      console.error("âŒ JWT í† í° ë””ì½”ë”© ì‹¤íŒ¨");
      return { success: false, error: 'Failed to decode JWT token' };
    }

    const originalTransactionId = payload.originalTransactionId;
    
    if (!originalTransactionId) {
      console.error("âŒ originalTransactionIdë¥¼ JWT payloadì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŒ");
      return { success: false, error: 'originalTransactionId not found in JWT payload' };
    }

    console.log("âœ… originalTransactionId ì¶”ì¶œ ì„±ê³µ:", originalTransactionId);
    
    return { 
      success: true, 
      originalTransactionId: originalTransactionId 
    };

  } catch (error) {
    console.error("âŒ App Store Server API v2 í˜¸ì¶œ ì‹¤íŒ¨:", error.message);
    
    if (error.response) {
      console.error("âŒ API ì‘ë‹µ ì—ëŸ¬:", error.response.status, error.response.data);
    }
    
    return { success: false, error: error.message };
  }
}

/**
 * JWT í† í°ì„ ë””ì½”ë”©í•˜ëŠ” í•¨ìˆ˜ (base64url decode)
 * @param {string} token
 * @returns {Object|null}
 */
function decodeJWT(token) {
  try {
    // JWTëŠ” header.payload.signature í˜•íƒœ
    const parts = token.split('.');
    if (parts.length !== 3) {
      console.error("âŒ JWT í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŒ");
      return null;
    }

    // payload ë¶€ë¶„ ë””ì½”ë”© (base64url)
    const payload = parts[1];
    const decodedPayload = Buffer.from(payload, 'base64url').toString('utf8');
    
    return JSON.parse(decodedPayload);
  } catch (error) {
    console.error("âŒ JWT ë””ì½”ë”© ì—ëŸ¬:", error);
    return null;
  }
}

module.exports = { extractOriginalTransactionId };
